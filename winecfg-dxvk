#!/bin/bash
set -euo pipefail

prefix="${1:?Usage: $0 <wineprefix>}"
arch="${2:-win64}"
winVersion="${3:-win10}"

export WINEPREFIX="${prefix}"
export WINEARCH="${arch}"

version="${4:-2.7.1}"
name="dxvk-${version}"
archive="${name}.tar.gz"
repo="${5:-doitsujin}"
url="https://github.com/${repo}/dxvk/releases/download/v${version}/${archive}"

if [[ -f "${archive}" ]]; then
  echo "Deleting ${archive}..."
  rm -v "${archive}"
fi

echo "Downloading ${archive}..."
curl -LO# "${url}"

if [[ -d "${name}" ]]; then
  echo "Deleting ${name}..."
  rm -rfv "${name}"
fi

echo "Extracting ${archive}..."
tar xzvf "${archive}"

winecfg -v "${winVersion}"

[[ "${arch}" == "win64" ]] && [[ -d "${name}/x64" ]] && cp -v "${name}/x64/"*.dll "${WINEPREFIX}/drive_c/windows/system32/"
[[ -d "${name}/x32" ]] && cp -v "${name}/x32/"*.dll "${WINEPREFIX}/drive_c/windows/syswow64/"

for dll in d3d8 d3d9 d3d10core d3d11 dxgi; do
  wine reg add "HKCU\\Software\\Wine\\DllOverrides" \
    /v "${dll}" /d native /f
done

echo "DXVK ${version} installed and DLLs registered as native."

echo "Killing wine server..."
wineserver -k
echo "Wine server killed."
